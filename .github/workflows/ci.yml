name: Generate iGOT build
on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        flavor: [qa]

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Ruby (required for Fastlane)
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      # Step 3: Install Fastlane
      - name: Install Fastlane
        run: gem install fastlane

      # Step 4: Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'

      # Step 5: Create .env file from Base64 secret
      - name: Create .env file for ${{ matrix.flavor }}
        run: |
          echo "Creating .env file for flavor: ${{ matrix.flavor }}..."
          if [ "${{ matrix.flavor }}" = "qa" ]; then
            echo "${{ secrets.QA_ENV }}" > .env.qa
            cp .env.qa .env
            echo ".env.qa created safely with URLs:"
            grep -E 'https?://' .env.qa || echo "No URLs found"
          elif [ "${{ matrix.flavor }}" = "uat" ]; then
            echo "${{ secrets.UAT_ENV_FILE }}" > .env.uat
            cp .env.uat .env
          else
            echo "${{ secrets.PROD_ENV_FILE }}" > .env.prod
            cp .env.prod .env
          fi
          echo ".env file created."

      # Step 6: Verify .env file (safe, only prints URLs)
      - name: Verify .env file contents
        run: |
          echo "File info:"
          ls -lh .env.${{ matrix.flavor }}
          echo "Line count:"
          wc -l .env.${{ matrix.flavor }}
          echo "Non-secret lines (URLs only):"
          grep -E 'https?://' .env.${{ matrix.flavor }} || echo "No URLs found"

      # Step 7: Generate env.dart for ${{ matrix.flavor }}
      - name: Generate env.dart for ${{ matrix.flavor }}
        run: |
          echo "Generating env.dart..."
          flutter pub run build_runner build --delete-conflicting-outputs
          echo "env.dart generated."

      # Step 8: Decode keystore from secret
      - name: Set up release keystore
        run: |
          echo "Decoding keystore from secret..."
          echo "${{ secrets.KEY_STORE }}" | base64 --decode > android/app/upload-keystore.jks
          ls -l android/app/

      # Step 9: Create key.properties for signing
      - name: Create key.properties for signing
        run: |
          echo "Creating key.properties..."
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=upload-keystore.jks" >> android/key.properties
          cat android/key.properties

      # Step 10: Run Fastlane to build APK
      - name: Run Fastlane lane for ${{ matrix.flavor }}
        env:
          FLAVOR: ${{ matrix.flavor }}
        run: |
          fastlane android distribute

      # Step 11: Upload build artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flutter-build-artifacts-${{ matrix.flavor }}
          path: |
            build/app/outputs/flutter-apk/app-${{ matrix.flavor }}-release.apk
            build/debug-info/${{ matrix.flavor }}